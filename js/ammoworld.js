(()=>{const e=class extends CABLES.EventTarget{constructor(){super(),this.world=null,this.bodies=[],this._countIndex=1,this._bodymeta={},this.lastTime=performance.now(),this._collisions=[],this.autoRemove=!0,this.setupWorld()}setupWorld(){this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.world=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.world.setGravity(new Ammo.btVector3(0,-9,0))}getListBodies(){const e=[];for(let t in this._bodymeta)e.push(this._bodymeta[t]);return e}dispose(){if(this.world){this.emitEvent("dispose");for(let e=0;e<this.bodies.length;e++)this.bodies[e]&&(this.world.removeRigidBody(this.bodies[e]),Ammo.destroy(this.bodies[e]));this.bodies=[],Ammo.destroy(this.world),this.world=null,Ammo.destroy(this.collisionConfiguration),Ammo.destroy(this.dispatcher),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.solver)}}removeRigidBody(e){const t=this.bodies.indexOf(e),i=e.getUserIndex();this.world&&e&&this.world.removeRigidBody(e),t>-1&&this.bodies.splice(t,1),delete this._bodymeta[i]}createRigidBody(){}addRigidBody(e){this.world&&(e.setUserIndex(++this._countIndex),this.world.addRigidBody(e),this.bodies.push(e))}setBodyMeta(e,t){0==e.getUserIndex()&&e.setUserIndex(++this._countIndex),t.body=e,this._bodymeta[e.getUserIndex()]=t}getBodyMeta(e){if(e)return this._bodymeta[e.getUserIndex()]}pingBody(e){const t=this._bodymeta[e.getUserIndex()];t&&(t.ping=Math.round(performance.now()))}getBodyByName(e){for(let t in this._bodymeta)if(this._bodymeta[t].name==e)return this._bodymeta[t].body}numBodies(){return this.bodies.length}_pingTimeout(){for(let e in this._bodymeta){const t=this._bodymeta[e];t.ping&&performance.now()-t.ping>50&&(t.removed=!0,this.removeRigidBody(t.body))}}frame(){if(!this.world)return;let e=performance.now()-this.lastTime;this.world.stepSimulation(e,5),this.autoRemove&&this._pingTimeout(),this._checkCollisions(),this.lastTime=performance.now()}activateAllBodies(){for(let e=0;e<this.bodies.length;e++)this.bodies[e].activate()}getCollisions(){return this._collisions}_checkCollisions(){let e=this.dispatcher.getNumManifolds();this._collisions.length=0;for(let t=0;t<e;t++){let e=this.dispatcher.getManifoldByIndexInternal(t),i=e.getNumContacts();for(let t=0;t<i;t++){let t=this.getBodyMeta(e.getBody0()),i=this.getBodyMeta(e.getBody1());t&&i&&this._collisions.push({name0:t.name,name1:i.name})}}}};e._getGeomTriangle=function(e,t){const i=[0,0,0,0,0,0,0,0,0];if(e.verticesIndices&&e.verticesIndices.length){const s=3*t,o=3*(t+1),r=3*(t+2);i[0]=e.vertices[3*e.verticesIndices[s]+0],i[1]=e.vertices[3*e.verticesIndices[s]+1],i[2]=e.vertices[3*e.verticesIndices[s]+2],i[3]=e.vertices[3*e.verticesIndices[o]+0],i[4]=e.vertices[3*e.verticesIndices[o]+1],i[5]=e.vertices[3*e.verticesIndices[o]+2],i[6]=e.vertices[3*e.verticesIndices[r]+0],i[7]=e.vertices[3*e.verticesIndices[r]+1],i[8]=e.vertices[3*e.verticesIndices[r]+2]}else i[0]=e.vertices[9*t+0],i[1]=e.vertices[9*t+1],i[2]=e.vertices[9*t+2],i[3]=e.vertices[9*t+3],i[4]=e.vertices[9*t+4],i[5]=e.vertices[9*t+5],i[6]=e.vertices[9*t+6],i[7]=e.vertices[9*t+7],i[8]=e.vertices[9*t+8];return i},e.createConvexHullFromGeom=function(e,t,i){i=i||[1,1,1];const s=new Ammo.btConvexHullShape,o=new Ammo.btVector3(0,0,0);new Ammo.btVector3(0,0,0),new Ammo.btVector3(0,0,0);let r=1;e.vertices.length/3>t&&t>0&&(r=Math.floor(e.vertices.length/3/t));for(let t=0;t<e.vertices.length/3;t+=r)o.setX(e.vertices[3*t+0]*i[0]),o.setY(e.vertices[3*t+1]*i[1]),o.setZ(e.vertices[3*t+2]*i[2]),s.addPoint(o,!0);return s.initializePolyhedralFeatures(),s},e.copyCglTransform=function(e,t){const i=new Ammo.btVector3(0,0,0),s=new Ammo.btQuaternion(0,0,0,1),o=vec3.create(),r=quat.create();mat4.getTranslation(o,e.mMatrix),mat4.getRotation(r,e.mMatrix),i.setValue(o[0],o[1],o[2]),s.setValue(r[0],r[1],r[2],r[3]),t.setOrigin(i),t.setRotation(s),Ammo.destroy(i),Ammo.destroy(s)},CABLES.AmmoWorld=e,((this.CABLES=this.CABLES||{}).COREMODULES=this.CABLES.COREMODULES||{}).Ammoworld={}.Cables})();