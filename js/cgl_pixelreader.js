(()=>{"use strict";CGL.PixelReader=class{constructor(){this.pixelData=null,this._finishedFence=!0,this._size=0,this._pbo=null}_fence(e){const i=e.gl;return this._finishedFence=!1,new Promise((function(t,n){if(e.aborted)return;let r=i.fenceSync(i.SYNC_GPU_COMMANDS_COMPLETE,0);r&&(i.flush(),function s(){if(e.aborted)return;const _=i.clientWaitSync(r,0,0);if(_==i.WAIT_FAILED)console.error("fence wait failed"),n&&n();else{if(_==i.TIMEOUT_EXPIRED)return setTimeout(s,0);_==i.CONDITION_SATISFIED||_==i.ALREADY_SIGNALED?(t(),i.deleteSync(r)):console.log("unknown fence status",_)}}())}))}read(e,i,t,n,r,s,_,a){if(CABLES.UI&&(!CABLES.UI.loaded||performance.now()-CABLES.UI.loadedTime<1e3))return;if(!this._finishedFence)return;const f=e.gl;let l=f.UNSIGNED_BYTE,h=1;if(e.aborted)return;if(!i)return;const o=t==CGL.Texture.TYPE_FLOAT,E=4*s*_;if(o&&(l=f.FLOAT,h=4),0==s||0==_||0==E)return;if(this._pixelData&&this._size==E*h||(this._pixelData=o?new Float32Array(E):new Uint8Array(E),this._size=E*h),0==this._size||!this._pixelData)return void console.error("readpixel size 0",this._size,s,_);this._finishedFence&&(this._pbo=f.createBuffer(),f.bindBuffer(f.PIXEL_PACK_BUFFER,this._pbo),f.bufferData(f.PIXEL_PACK_BUFFER,this._pixelData.byteLength,f.DYNAMIC_READ),f.bindFramebuffer(f.FRAMEBUFFER,i),f.bindBuffer(f.PIXEL_PACK_BUFFER,this._pbo),e.profileData.profileFencedPixelRead++,f.readPixels(n,r,s,_,f.RGBA,l,0),f.bindBuffer(f.PIXEL_PACK_BUFFER,null),f.bindFramebuffer(f.FRAMEBUFFER,null));let u=this._pixelData.byteLength;this._finishedFence&&this._pbo&&this._fence(e).then((e=>{this._wasTriggered=!1,this._finishedFence=!0,!e&&this._pixelData&&this._pixelData.byteLength==u&&(f.bindBuffer(f.PIXEL_PACK_BUFFER,this._pbo),f.getBufferSubData(f.PIXEL_PACK_BUFFER,0,this._pixelData),f.bindBuffer(f.PIXEL_PACK_BUFFER,null),a&&a(this._pixelData)),f.deleteBuffer(this._pbo),this._pbo=null}))}},((this.CGL=this.CGL||{}).COREMODULES=this.CGL.COREMODULES||{}).Pixelreader={}.Pixelreader})();